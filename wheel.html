<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="theme-color" content="#222" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>–ö–æ–ª–µ—Å–æ —Ñ–æ—Ä—Ç—É–Ω—ã</title>
  <style>
    body {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 100vh;
      width: 100vw;
      margin: 0;
      padding: 0;
      background: linear-gradient(135deg, #222, #333);
      font-family: Arial, sans-serif;
      overflow: hidden;
    }
    #wheel-container {
      width: 80vw;
      max-width: 500px;
      max-height: 80vh;
      aspect-ratio: 1 / 1;
      position: relative;
      margin-bottom: 20px;
    }
    #pointer {
      width: 0;
      height: 0;
      position: absolute;
      bottom: -30px;
      left: 50%;
      transform: translateX(-50%);
      border-left: 25px solid transparent;
      border-right: 25px solid transparent;
      border-bottom: 40px solid #000;
      animation: none;
      /* –°—Ç—Ä–µ–ª–∫–∞ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∞ –≤–≤–µ—Ä—Ö, —Å—Ç–æ–∏—Ç —Å–Ω–∏–∑—É */
    }
    #pointer::after {
      content: '';
      position: absolute;
      left: -25px;
      top: 0;
      width: 0;
      height: 0;
      border-left: 25px solid transparent;
      border-right: 25px solid transparent;
      border-bottom: 40px solid #000;
      filter: drop-shadow(0 0 4px white);
    }
    canvas {
      width: 100%;
      height: 100%;
      border: 4px solid #fff;
      border-radius: 50%;
      box-shadow: 0 0 20px rgba(255, 255, 255, 0.3);
      background: #fff;
    }
    #rewardPopup {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.85);
      color: #fff;
      padding: 20px 30px;
      border-radius: 12px;
      font-size: 22px;
      font-weight: bold;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.3s ease;
      z-index: 100;
      text-align: center;
    }
  </style>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
  <div id="wheel-container">
    <div id="pointer"></div>
    <canvas id="wheel"></canvas>
  </div>
  <div id="rewardPopup"></div>
  <script>
    Telegram.WebApp.ready();
    Telegram.WebApp.expand();

    const canvas = document.getElementById('wheel');
    const ctx = canvas.getContext('2d');
    const pointer = document.getElementById('pointer');
    const wheelContainer = document.getElementById('wheel-container');

    const rewards = [
      { type: 'exp_loss', value: 12, text: '-12 –æ–ø—ã—Ç–∞', color: '#C62828' }, 
      { type: 'exp_gain', value: 12, text: '+12 –æ–ø—ã—Ç–∞', color: '#388E3C' },
      { type: 'exp_loss', value: 6, text: '-6 –æ–ø—ã—Ç–∞', color: '#E57373' }, 
      { type: 'item', value: 'legendary', text: 'üéÅ', color: '#FFD700' }, 
      { type: 'exp_loss', value: 3, text: '-3 –æ–ø—ã—Ç–∞', color: '#EF9A9A' }, 
      { type: 'premium', value: 7, text: '–ü—Ä–µ–º–∏—É–º –∞–∫–∫–∞—É–Ω—Ç (7 –¥–Ω–µ–π)', color: '#6A1B9A' },
      { type: 'exp_loss', value: 3, text: '-3 –æ–ø—ã—Ç–∞', color: '#EF9A9A' },
      { type: 'raid', value: 'clear', text: '–°–±—Ä–æ—Å —Ç–∞–π–º–µ—Ä–∞ /raid', color: '#1565C0' },
      { type: 'exp_loss', value: 24, text: '-24 –æ–ø—ã—Ç–∞', color: '#B71C1C' },  
      { type: 'exp_gain', value: 6, text: '+6 –æ–ø—ã—Ç–∞', color: '#81C784' },  
      { type: 'none', value: 'none', text: '–ü–æ–≤–µ–∑—ë—Ç –≤ —Å–ª–µ–¥—É—é—â–∏–π —Ä–∞–∑', color: '#D32F2F' },  
      { type: 'exp_loss', value: 15, text: '-15 –æ–ø—ã—Ç–∞', color: '#F44336' },  
      { type: 'item', value: 'epic', text: 'üéÅ', color: '#8E24AA' },   
      { type: 'exp_loss', value: 18, text: '-18 –æ–ø—ã—Ç–∞', color: '#AD1457' },    
      { type: 'exp_gain', value: 30, text: '+30 –æ–ø—ã—Ç–∞', color: '#2E7D32' },
      { type: 'exp_loss', value: 21, text: '-21 –æ–ø—ã—Ç–∞', color: '#E53935' },
      { type: 'exp_gain', value: 24, text: '+24 –æ–ø—ã—Ç–∞', color: '#43A047' },
    ];

    const anglePerSegment = (2 * Math.PI) / rewards.length;
    let currentAngle = 0;
    let spinning = false;
    let spinVelocity = 0;

    // –í—Ö–æ–¥–Ω–æ–π –ø–∞—Ä–∞–º–µ—Ç—Ä ‚Äî –∏–Ω–¥–µ–∫—Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞, –ø–æ–ª—É—á–µ–Ω–Ω–æ–≥–æ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞
    // –ù–∞–ø—Ä–∏–º–µ—Ä, —Å—é–¥–∞ –ø—Ä–∏–ª–µ—Ç–∞–µ—Ç index, –∫–æ—Ç–æ—Ä—ã–π –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤—ã–∏–≥—Ä—ã—à–µ–º
    // –ü—Ä–∏–º–µ—Ä: const forcedResultIndex = 7;

    // –î–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏, –ø–æ—Å—Ç–∞–≤–∏–º forcedResultIndex –≤ –≥–ª–æ–±–∞–ª—å–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é,
    // –≤ —Ä–µ–∞–ª—å–Ω–æ–º –∫–æ–¥–µ –Ω–∞–¥–æ –ø–æ–ª—É—á–∞—Ç—å —á–µ—Ä–µ–∑ Telegram.WebApp.initDataUnsafe –∏–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –±–æ—Ç–∞.
    let forcedResultIndex = null;

    function drawWheel() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      const centerX = canvas.width / 2;
      const centerY = canvas.height / 2;
      const baseRadius = canvas.width / 2 - 20;
      const extendedRadius = baseRadius + 20;

      rewards.forEach((reward, index) => {
        const startAngle = currentAngle + anglePerSegment * index;
        const endAngle = startAngle + anglePerSegment;

        ctx.beginPath();
        ctx.moveTo(centerX, centerY);
        ctx.arc(centerX, centerY, extendedRadius, startAngle, endAngle);
        ctx.fillStyle = reward.color;
        ctx.fill();
        ctx.lineWidth = 2;
        ctx.strokeStyle = '#fff';
        ctx.stroke();

        const midAngle = startAngle + anglePerSegment / 2;
        const isEmoji = /^[^\w\s]+$/.test(reward.text);
        const fontSize = isEmoji
          ? Math.max(10, canvas.width / 18)
          : Math.max(10, canvas.width / 40);

        ctx.font = `bold ${fontSize}px "Segoe UI Emoji", Arial`;
        ctx.fillStyle = '#fff';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';

        ctx.save();
        if (isEmoji) {
          const x = centerX + baseRadius * 0.7 * Math.cos(midAngle);
          const y = centerY + baseRadius * 0.7 * Math.sin(midAngle);
          ctx.fillText(reward.text, x, y);
        } else {
          ctx.translate(centerX, centerY);
          ctx.rotate(midAngle);
          ctx.fillText(reward.text, baseRadius * 0.7, 0);
        }
        ctx.restore();
      });
    }

    // –°—Ç—Ä–µ–ª–∫–∞ —Å–º–æ—Ç—Ä–∏—Ç –≤–≤–µ—Ä—Ö, –∑–Ω–∞—á–∏—Ç pointerAngle = -œÄ/2
    const pointerAngle = -Math.PI / 2;

    // –°–ø–∏–Ω —Å —É—á—ë—Ç–æ–º –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
    let animationStartTime = null;
    const spinDuration = 5000; // –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∞–Ω–∏–º–∞—Ü–∏–∏ —Å–ø–∏–Ω–∞ –≤ –º—Å

    function animate(timestamp) {
      if (!animationStartTime) animationStartTime = timestamp;

      const elapsed = timestamp - animationStartTime;

      if (forcedResultIndex === null) {
        // –ï—Å–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –Ω–µ –∑–∞–¥–∞–Ω, –ø—Ä–æ—Å—Ç–æ –∫—Ä—É—Ç–∏–º —Å –∑–∞—Ç—É—Ö–∞–Ω–∏–µ–º
        if (spinning) {
          currentAngle += spinVelocity;
          spinVelocity *= 0.985;
          if (spinVelocity < 0.002) {
            spinning = false;
            showResult();
          }
        }
      } else {
        // –ê–Ω–∏–º–∞—Ü–∏—è —Å –∑–∞—Ä–∞–Ω–µ–µ –∏–∑–≤–µ—Å—Ç–Ω—ã–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º ‚Äî –ø–ª–∞–≤–Ω–æ –¥–æ—Ç—è–Ω—É—Ç—å –∫–æ–ª–µ—Å–æ –¥–æ –Ω—É–∂–Ω–æ–≥–æ —É–≥–ª–∞

        // –¶–µ–ª–µ–≤–æ–π —É–≥–æ–ª –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏:
        // –≤—Ä–∞—â–∞–µ–º –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–æ–ª–Ω—ã—Ö –æ–±–æ—Ä–æ—Ç–æ–≤ + –ø–æ–∑–∏—Ü–∏—è –Ω—É–∂–Ω–æ–≥–æ —Å–µ–∫—Ç–æ—Ä–∞ —Å –ø–æ–ø—Ä–∞–≤–∫–æ–π –Ω–∞ —Å—Ç—Ä–µ–ª–∫—É
        const totalSpins = 6; // –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ª–Ω—ã—Ö –æ–±–æ—Ä–æ—Ç–æ–≤ –ø–µ—Ä–µ–¥ –æ—Å—Ç–∞–Ω–æ–≤–∫–æ–π
        const targetAngle = 
          totalSpins * 2 * Math.PI + // –ø–æ–ª–Ω—ã–µ –æ–±–æ—Ä–æ—Ç—ã
          (rewards.length - forcedResultIndex) * anglePerSegment - // —Å–µ–∫—Ç–æ—Ä, —É—á–∏—Ç—ã–≤–∞—è –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤—Ä–∞—â–µ–Ω–∏—è
          pointerAngle + // –ø–æ–ø—Ä–∞–≤–∫–∞ –Ω–∞ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç—Ä–µ–ª–∫–∏ (—Å—Ç—Ä–µ–ª–∫–∞ —Å–º–æ—Ç—Ä–∏—Ç –≤–≤–µ—Ä—Ö)
          anglePerSegment / 2; // —Ü–µ–Ω—Ç—Ä —Å–µ–∫—Ç–æ—Ä–∞

        // easeOut —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–ª–∞–≤–Ω–æ–≥–æ –∑–∞–º–µ–¥–ª–µ–Ω–∏—è
        function easeOut(t) {
          return 1 - Math.pow(1 - t, 3);
        }

        const progress = Math.min(elapsed / spinDuration, 1);
        currentAngle = targetAngle * easeOut(progress);

        if (progress === 1) {
          spinning = false;
          showResult();
          forcedResultIndex = null; // —Å–±—Ä–æ—Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ —Å–ø–∏–Ω–∞
        }
      }

      drawWheel();

      if (spinning || forcedResultIndex !== null) {
        requestAnimationFrame(animate);
      }
    }

    function showResult() {
      const popup = document.getElementById('rewardPopup');
      const reward = rewards[forcedResultIndex ?? Math.floor(
        ((2 * Math.PI - (currentAngle % (2 * Math.PI)) + Math.PI / 2) % (2 * Math.PI)) / anglePerSegment
      )];
      
      pointer.style.animation = 'bounce 0.5s ease';
      setTimeout(() => pointer.style.animation = 'none', 500);

      popup.textContent = reward.text;
      popup.style.opacity = '1';

      setTimeout(() => {
        Telegram.WebApp.sendData(JSON.stringify({ type: reward.type, value: reward.value, index: forcedResultIndex }));
      }, 500);

      setTimeout(() => {
        popup.style.opacity = '0';
      }, 2000);

      setTimeout(() => {
        Telegram.WebApp.close();
      }, 2500);
    }

    // –í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ –±–æ—Ç–∞
    window.Telegram.WebApp.onEvent('mainButtonClicked', () => {
      // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º ‚Äî —É –Ω–∞—Å –Ω–µ—Ç –∫–Ω–æ–ø–∫–∏ —Å–ø–∏–Ω–∞
    });

    // –ñ–¥—ë–º –∫–æ–º–∞–Ω–¥—É –æ—Ç –±–æ—Ç–∞ —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º
    window.Telegram.WebApp.onEvent('data', (data) => {
      try {
        const parsed = JSON.parse(data);
        if (typeof parsed.index === 'number' && parsed.index >= 0 && parsed.index < rewards.length) {
          forcedResultIndex = parsed.index;
          spinning = true;
          animationStartTime = null;
          animate(performance.now());
        }
      } catch(e) {
        console.error('–û—à–∏–±–∫–∞ —Ä–∞–∑–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –æ—Ç –±–æ—Ç–∞:', e);
      }
    });

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    function resizeCanvas() {
      canvas.width = wheelContainer.offsetWidth;
      canvas.height = wheelContainer.offsetHeight;
      drawWheel();
    }

    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();
    drawWheel();
  </script>
</body>
</html>
