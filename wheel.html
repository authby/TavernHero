<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
  />
  <title>–ö–æ–ª–µ—Å–æ —Ñ–æ—Ä—Ç—É–Ω—ã</title>
  <meta name="theme-color" content="#222" />

  <style>
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      min-height: 100vh;
      overflow: hidden;
      background: linear-gradient(135deg, #222, #333);
      display: flex;
      justify-content: center;
      align-items: center;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      position: relative; /* ‚ùó –ù–ï fixed */
    }

    #wheel-container {
      position: relative;
      width: min(90vw, 90vh);
      height: min(90vw, 90vh);
      max-width: 600px;
      max-height: 600px;
    }

    canvas {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      background: #fff;
      border: 2px solid #fff;
      box-shadow: 0 0 12px rgba(255,255,255,0.25);
      touch-action: none;
    }

    #pointer {
      position: absolute;
      top: calc(100% - 2px);
      left: 50%;
      transform: translateX(-50%) rotate(180deg);
      width: 0;
      height: 0;
      border-left: 18px solid transparent;
      border-right: 18px solid transparent;
      border-top: 28px solid #000;
      z-index: 10;
    }

    #rewardPopup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0,0,0,0.85);
      color: #fff;
      padding: 14px 22px;
      border-radius: 12px;
      font-size: 16px;
      font-weight: bold;
      opacity: 0;
      transition: opacity 0.3s ease;
      z-index: 100;
      max-width: 90%;
      text-align: center;
      pointer-events: none;
    }
  </style>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>

  <div id="wheel-container">
    <canvas id="wheel"></canvas>
    <div id="pointer"></div>
  </div>

  <div id="rewardPopup"></div>

<script>
/* ================= TELEGRAM INIT ================= */

if (window.Telegram && Telegram.WebApp) {
  Telegram.WebApp.ready();
  Telegram.WebApp.expand();

  Telegram.WebApp.onEvent('viewportChanged', (e) => {
    document.documentElement.style.height = `${e.height}px`;
    document.body.style.height = `${e.height}px`;
    safeResize();
  });
}

/* ================= DATA ================= */

const rewards = [
  { type:'tokens', value:25, text:'üí∞ 25 –ñ–µ—Ç–æ–Ω–æ–≤', color:'#F44336' },
  { type:'exp_gain', value:12, text:'–û–ø—ã—Ç +12', color:'#2E7D32' },
  { type:'exp_loss', value:6, text:'–û–ø—ã—Ç -6', color:'#AD1457' },
  { type:'item', value:'legendary', text:'üéÅ', color:'#FFD700' },
  { type:'exp_loss', value:12, text:'–û–ø—ã—Ç -12', color:'#D32F2F' },
  { type:'premium', value:3, text:'–ü—Ä–µ–º–∏—É–º (3 –¥–Ω—è)', color:'#689F38' },
  { type:'exp_loss', value:3, text:'–û–ø—ã—Ç -3', color:'#1976D2' },
  { type:'raid', value:'clear', text:'–°–±—Ä–æ—Å /raid', color:'#F57C00' },
  { type:'exp_loss', value:24, text:'–û–ø—ã—Ç -24', color:'#D32F2F' },
  { type:'exp_gain', value:6, text:'–û–ø—ã—Ç +6', color:'#0288D1' },
  { type:'none', value:'none', text:'–ü–æ–≤–µ–∑—ë—Ç –≤ –¥—Ä—É–≥–æ–π —Ä–∞–∑', color:'#555' },
  { type:'exp_loss', value:15, text:'–û–ø—ã—Ç -15', color:'#00796B' },
  { type:'item', value:'epic', text:'üéÅ', color:'#8E24AA' },
  { type:'exp_loss', value:18, text:'–û–ø—ã—Ç -18', color:'#F44336' },
  { type:'exp_gain', value:30, text:'–û–ø—ã—Ç +30', color:'#689F38' },
  { type:'exp_loss', value:21, text:'–û–ø—ã—Ç -21', color:'#1976D2' },
];

const segmentCount = rewards.length;
const anglePerSegment = (2 * Math.PI) / segmentCount;

/* ================= CANVAS ================= */

const canvas = document.getElementById('wheel');
const ctx = canvas.getContext('2d');
const popup = document.getElementById('rewardPopup');

let currentAngle = 0;
let totalRotation = 0;
let startTime = null;
let resultIndex = null;

function safeResize() {
  if (!canvas.offsetWidth || !canvas.offsetHeight) {
    requestAnimationFrame(safeResize);
    return;
  }
  canvas.width = canvas.offsetWidth * devicePixelRatio;
  canvas.height = canvas.offsetHeight * devicePixelRatio;
  drawWheel();
}

function drawWheel(highlight = null) {
  const cx = canvas.width / 2;
  const cy = canvas.height / 2;
  const radius = canvas.width / 2 - 5;

  ctx.clearRect(0,0,canvas.width,canvas.height);

  for (let i = 0; i < segmentCount; i++) {
    const start = currentAngle + i * anglePerSegment;
    const end = start + anglePerSegment;

    ctx.beginPath();
    ctx.moveTo(cx,cy);
    ctx.arc(cx,cy,radius,start,end);
    ctx.closePath();
    ctx.fillStyle = rewards[i].color;
    ctx.fill();
    ctx.strokeStyle = '#fff';
    ctx.stroke();

    const mid = start + anglePerSegment / 2;
    ctx.save();
    ctx.translate(cx,cy);
    ctx.rotate(mid);
    ctx.fillStyle = '#fff';
    ctx.font = `${Math.max(14, radius / 14)}px sans-serif`;
    ctx.textAlign = 'right';
    ctx.fillText(rewards[i].text, radius - 12, 0);
    ctx.restore();
  }
}

/* ================= ANIMATION ================= */

function animate(ts) {
  if (!startTime) startTime = ts;
  const t = Math.min((ts - startTime) / 4000, 1);
  const ease = 1 - Math.pow(1 - t, 3);
  currentAngle = totalRotation * ease;
  drawWheel(t === 1 ? resultIndex : null);

  if (t < 1) {
    requestAnimationFrame(animate);
  } else {
    showReward();
  }
}

function spinTo(index) {
  resultIndex = index;
  startTime = null;
  currentAngle = 0;

  const turns = 6;
  const sectorAngle = index * anglePerSegment;
  totalRotation = (2 * Math.PI * turns) + Math.PI / 2 - sectorAngle;

  requestAnimationFrame(animate);
}

/* ================= RESULT ================= */

function showReward() {
  popup.textContent = rewards[resultIndex].text;
  popup.style.opacity = '1';

  setTimeout(() => {
    Telegram.WebApp.sendData(JSON.stringify({
      ...rewards[resultIndex],
      session_id: sessionId
    }));
  }, 800);

  setTimeout(() => Telegram.WebApp.close(), 1200);
}

/* ================= START ================= */

const params = new URLSearchParams(location.search);
const indexParam = parseInt(params.get('index'), 10);
const sessionId = params.get('session_id');

safeResize();

if (!isNaN(indexParam)) {
  setTimeout(() => spinTo(indexParam), 200);
}
</script>

</body>
</html>
